{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"CI/CD Examples","text":"<p>This website contains examples on how to develop CI/CD pipelines and how to configure development environment for working with CI/CD pipelines.</p>"},{"location":"#installing-docker","title":"Installing Docker","text":"<p>See Get Docker for installation instructions.</p> <p>If you use Docker a lot on Mac or Windows system, the recommended Docker Desktop is likely a good option for you. Note that, since January 2022, it has required paid subscription if used for commercial development.</p> <p>Alternatively, Windows users can install Docker on top of WSL2. For Mac users there are alternatives, such as Colima, available.</p>"},{"location":"examples/docker/docker-on-wsl/","title":"Install Docker on Windows Subsystem for Linux","text":"<p>If you do not already have Windows Subsystem for Linux (WSL) installed, see Install Linux on Windows with WSL for instructions.</p> <p>This document describes how to configure WSL 2, install recent version of Ubuntu (24.04 LTS), and install Docker as well as Docker compose.</p>"},{"location":"examples/docker/docker-on-wsl/#configure-wsl-settings","title":"Configure WSL settings","text":"<p>Open PowerShell and check current WSL status by running <code>wsl --status</code>.</p> <pre><code>wsl --status\n</code></pre> <p>If default version is not 2, run <code>wsl --set-default-version 2</code>. This enables more recent, virtual machine based WSL, that is required for us to be able to run Docker daemon in the WSL.</p> <pre><code>wsl --set-default-version 2\n</code></pre> <p>If output indicates any problems with WSL 2 Kernel, such as <code>The WSL 2 kernel file is not found.</code>, run <code>wsl --update</code> and <code>wsl --shutdown</code>, as suggested. These command might require admin priviledges. To obtain these, find PowerShell, right click it, and select Run as System Administrator.</p> <pre><code>wsl --update\nwsl --shutdown\n</code></pre> <p>Run <code>wsl --status</code> again. The output should display 2 as default version, recent last update date, and kernel version.</p> <p>If you already have recent version of Ubuntu installed, ensure that it uses WSL 2 by running <code>wsl --list --verbose</code>. If necessary, use <code>wsl --set-version</code> to update your instance to use WSL 2. Skip next section.</p> <pre><code>wsl --list --verbose\nwsl --set-version \"YOUR_DISTRO_HERE\" 2\n</code></pre> WSL commands only output usage instructions <p>If the <code>wsl</code> command outputs usage instructions instead of the expected output regardless of given parameters, ensure that your system has following Windows features enabled:</p> <ul> <li>Windows Subsystem for Linux</li> <li>Virtual Machine Platform</li> <li>Hyper-V</li> </ul> <p>To do this, open the Turn Windows Features on or off dialog from Start menu, Settings, or Control Panel, and ensure that the features mentioned above are selected.</p>"},{"location":"examples/docker/docker-on-wsl/#install-recent-version-of-ubuntu","title":"Install recent version of Ubuntu","text":"<p>Install recent version of Ubuntu from either Microsoft Store or PowerShell. These instructions use Ubuntu 24.04. Other distributions might also work, if you know what you are doing.</p> PowerShellMicrosoft Store <p>If you want to install distro through the PowerShell, run <code>wsl --list --online</code> and follow the instructions:</p> <pre><code>wsl --list --online\nwsl --install -d Ubuntu-24.04\n</code></pre> <p>If you want to install distro through Microsoft Store: Open Microsoft Store, search for <code>Ubuntu 24</code>, select Ubuntu 24.04 LTS, and click Install.</p> <p>If not launched automatically, open the installed Ubuntu distro (e.g., by clicking it in the Start menu) and follow instruction in installation wizard. You will have to choose an username and a password to use in the WSL instance. To make your life easier, use only lowercase letters and numbers in your Linux username.</p>"},{"location":"examples/docker/docker-on-wsl/#install-docker","title":"Install Docker","text":"<p>Open Ubuntu you just installed and follow Install Docker Engine on Ubuntu instructions.</p> <p>tl;dr: Run the convenience script available in <code>get.docker.com</code>:</p> <pre><code>curl -fsSL https://get.docker.com -o get-docker.sh\nsudo sh get-docker.sh\n</code></pre> <p>Ignore the <code>WSL DETECTED: We recommend using Docker Desktop for Windows.</code> warning.</p> <p>To be able to run docker commands without <code>sudo</code>, add current user to <code>docker</code> group with <code>usermod</code>. Note that you might have to logout and login for the changes to take effect.</p> <pre><code>sudo usermod -aG docker $USER\n</code></pre>"},{"location":"examples/docker/docker-on-wsl/#configure-networking","title":"Configure networking","text":"<p>By default, WSL 2 uses local DNS server to reflect network settings, such as VPN, from the host Windows to WSL instances. The IP address of this DNS server might fall into IP range used by the Dockers default bridge network. In that case, containers will not be able to resolve domains.</p> <p>To configure working DNS inside containers you can either modify IP range used by Dockers default network or use public DNS. If you are working behind a corporate firewall, public DNS might not work.</p> Configure IP range for DockerUse public DNS in WSL 2 <p>To configure Docker to use IP ranges that wont overlap with DNS server configured by WSL, add following content to <code>/etc/docker/daemon.json</code>, for example, by opening it with <code>sudo nano /etc/docker/daemon.json</code>:</p> /etc/docker/daemon.json<pre><code>{\n  \"bip\": \"172.21.0.1/16\",\n  \"default-address-pools\": [\n    {\n      \"base\":\"172.22.0.0/16\",\n      \"size\":24\n    }\n  ]\n}\n</code></pre> <p>If you already have dockerd running, you have to restart it for the changes to take effect.</p> <pre><code>sudo service docker restart\n</code></pre> <p>If containers cannot resolve domains or have other issues with internet access with above configuration, ensure that the above networks do not overlap with network interface configured by WSL. To do this, run <code>ip a</code> or <code>ifconfig</code> command ( or <code>ipconfig</code> in powershell) and check the IP address assigned for <code>eth0</code> interface it output. If the second part of the IP address matches either IP block defined in the above configuration, change the value in <code>/etc/docker/daemon.json</code>. Any private IP v4 address block should work. You can use, for example, some blocks between <code>172.16.0.0/16</code> and <code>172.31.0.0/16</code>, i.e., change the second part of the IP address.</p> <p>To use public DNS, you must first disable WSL from automatically generating DNS settings to <code>/etc/resolv.conf</code>. To do this, add following rows to <code>/etc/wsl.conf</code> file in your WSL instance, for example, by editing (or creating) it with <code>sudo nano /etc/wsl.conf</code>:</p> /etc/wsl.conf<pre><code>[network]\ngenerateResolvConf = false\n</code></pre> <p>For the changes to take effect, restart WSL by running <code>wsl --shutdown</code> in powershell and launching WSL instance again.</p> <pre><code>wsl --shutdown\n</code></pre> <p>Finally, configure DNS server manually by creating <code>/etc/resolv.conf</code> with following content, for example by opening it with <code>sudo nano /etc/resolv.conf</code>:</p> /etc/resolv.conf<pre><code>nameserver 8.8.8.8\n</code></pre>"},{"location":"examples/docker/docker-on-wsl/#ensure-docker-daemon-is-running","title":"Ensure Docker daemon is running","text":"<p>Recent version of WSL enable systemd by default. In this case, Docker daemon should be started automatically when ever WSL is running. To verify Docker has been started, run the hello-world container:</p> <pre><code>docker run hello-world\n</code></pre> <p>If Docker was not started automatically, start <code>dockerd</code> as a background process by using <code>service</code> or, alternatively, start <code>dockerd</code> directly.</p> <pre><code>sudo service docker start\n</code></pre> <p>If <code>docker</code> commands print <code>Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?</code> error, run <code>sudo service docker status</code> command to check if <code>dockerd</code> is running and, if necessary, run <code>sudo service docker start</code> command to start the Docker service.</p> Launch docker with boot settings <p>If you are working on earlier version of Windows 11, you can use boot settings to start Docker daemon automatically on WSL instance startup. To do this, add following rows to <code>/etc/wsl.conf</code> file in your WSL instance, for example, by editing (or creating) it with <code>sudo nano /etc/wsl.conf</code>.</p> /etc/wsl.conf<pre><code>[boot]\ncommand = service docker start\n</code></pre> <p>Note that this should not be done if systemd is enabled.</p>"},{"location":"examples/docker/docker-on-wsl/#install-docker-compose","title":"Install Docker compose","text":"<p>Follow Install Docker Compose instructions for Linux.</p> <p>tl;dr: Install Docker Compose with the distros package manager:</p> <pre><code>sudo apt-get update\nsudo apt-get install docker-compose-plugin\n</code></pre>"},{"location":"examples/jenkins/ansible-kubernetes/","title":"Deploy application to Kubernetes with Ansible","text":"<p>This example contains a pipeline that deploys an simple hello-world application to a Kubernetes cluster.</p>"},{"location":"examples/jenkins/ansible-kubernetes/#prerequisites","title":"Prerequisites","text":"<p>You will need a running Kubernetes cluster, that supports services with <code>LoadBalancer</code> type, and a kubeconfig file that can be used to deploy application (a deployment and a service) into the cluster.</p>"},{"location":"examples/jenkins/ansible-kubernetes/#preparing-the-jenkins-instance","title":"Preparing the Jenkins instance","text":"<p>The pipeline provided by this example can be added to any Jenkins instance you have administrator access and can run pipeline stages with docker agent. For example, Jenkins configuration from Jenkins with access to hosts Docker engine example can be used.</p> <p>We will use secret file to configure credentials for managing the target Kubernetes cluster. To create the secret file credential, open Global credentials from Jenkins credentials store from Manage Jenkins &gt; Manage Credentials and click Add Credentials from the left side menu.</p> <p>In the New credentials form:</p> <ol> <li>Select Secret file as the credential kind</li> <li>Upload your kubeconfig to the file input</li> <li>Configure ID for the credential. Jenkinsfile uses <code>kubeconfig</code> as the ID.</li> <li>(Optionally) add a description.</li> </ol>"},{"location":"examples/jenkins/ansible-kubernetes/#configure-the-pipeline","title":"Configure the pipeline","text":"<p>First, create a new pipeline via New Item button in the rigth side menu of the Jenkins dashboard. The name of the pipeline could be for example <code>Animals</code> and it should be an pipeline.</p> <p>In the configure pipeline view, scroll to the bottom and under Pipeline sub-header select <code>Pipeline script from SCM</code>. SCM type should be <code>Git</code> and Repository URL the url of this repository: <code>https://github.com/kangasta/cicd-examples.git</code>. Ensure that branch specifier includes <code>main</code> branch of the repository and modify the Script Path to be <code>docs/examples/jenkins/ansible-kubernetes/Jenkinsfile</code>.</p> <p>After you have created the pipeline, try to execute it by clicking Build Now. The pipeline should have deployed the example application into the Kubernetes cluster with the default image tag (<code>cow</code>) defined in the deploy-to-kubernetes.yml Ansible playbook.</p> <p>You can find the URL of the created load-balancer from the console output of the build. Open the application with your browser or user curl to see the application response.</p> <p>In addition, after the first execution Jenkins should have updated the project configuration to contain parameters defined in the pipeline and we can configure the image tag in Build with Parameters menu.</p>"},{"location":"examples/jenkins/build-status-pipelines/","title":"Build status pipelines and Job DSL","text":"<p>This example contains pipelines to produce builds with success, unstable, failed, aborted, and not-built statuses as well as Job DSL script to create a folder with projects that have these five different statuses.</p>"},{"location":"examples/jenkins/build-status-pipelines/#preparing-the-jenkins-instance","title":"Preparing the Jenkins instance","text":"<p>The pipeline provided by this example can be added to any Jenkins instance you have administrator access. For example, Jenkins configuration from Jenkins with access to hosts Docker engine example can be used.</p> <p>In order to be able to run the seed project we will need Job DSL plugin. Install the plugin through Available tab in Manage Jenkins &gt; Manage Plugins.</p>"},{"location":"examples/jenkins/build-status-pipelines/#creating-and-running-the-seed-project","title":"Creating and running the seed project","text":"<p>To run the job DSL script, create a new pipeline with following script as an inline pipeline script and run the created pipeline.</p> <pre><code>node {\n    git branch: 'main', url: 'https://github.com/kangasta/cicd-examples.git'\n    jobDsl targets: 'docs/examples/jenkins/build-status-pipelines/jobs.groovy'\n}\n</code></pre> <p>The execution will likely fail with <code>ERROR: script not yet approved for use</code> message. To enable this script, navigate to Manage Jenkins &gt; In-process Script Approval, inspect the script, and click Approve. Then try to run the created seed project again. It should now succeed and list the created resources.</p>"},{"location":"examples/jenkins/jenkins-host-docker/","title":"Jenkins with access to hosts Docker engine","text":"<p>Note that by default each of the example docker compose configurations will create their own volumes for the data. This might not be what you want. In order to use the same volumes for every docker compose configuration, run docker compose with <code>-p</code> (or <code>--project-name</code>) option. This can also be done by setting <code>COMPOSE_PROJECT_NAME</code> environment variable:</p> <pre><code>export COMPOSE_PROJECT_NAME=jenkins\n</code></pre>"},{"location":"examples/jenkins/jenkins-host-docker/#jenkins-image-with-docker-client","title":"Jenkins image with Docker client","text":"<p>To be able run Docker commands from inside the Jenkins container, we will need to install the Docker client. This can be done with a suitable Dockerfile:</p> Dockerfile<pre><code>FROM jenkins/jenkins:lts-alpine\n\n# Change user to root in order to have permissions to install packages.\nUSER root\n\n# Only Docker client is required inside the Jenkins container as the host systems Docker engine is used from inside the container.\nRUN apk add docker-cli\n\n# Note that the user is not switched back to jenkins here. This is to avoid problems with docker socket permissions.\n# Do not use root user in production. Instead, match group IDs of docker groups in host and container and add jenkins user to docker group.\n</code></pre>"},{"location":"examples/jenkins/jenkins-host-docker/#jenkins-container-with-access-to-hosts-docker-engine","title":"Jenkins container with access to hosts Docker engine","text":"<p>When running Jenkins in a container, we will want to define ports and volumes. To do this, we will use a <code>docker-compose.yml</code> configuration:</p> docker-compose.yml<pre><code>services:\n  jenkins:\n    build: .\n    ports:\n      # Web user interface\n      - 8080:8080\n      # Java agents\n      - 50000:50000\n    volumes:\n      # Persistent volume for the Jenkins data\n      - \"jenkins.data:/var/jenkins_home\"\n      # Host systems docker socket\n      - \"/var/run/docker.sock:/var/run/docker.sock\"\n\nvolumes:\n  jenkins.data:\n</code></pre> <p>These files are available in the repository that provides this website. In order to run Jenkins container with Docker-in-Docker support, <code>cd</code> into <code>docs/examples/jenkins/jenkins-host-docker</code> directory and run <code>docker compose up</code>.</p> <pre><code>cd docs/examples/jenkins/jenkins-host-docker\n\n# If you want to see logs in the current terminal\ndocker compose up --build\n\n# Or if you want to run the container in the background\ndocker compose up --build --detach\n</code></pre> <p>The initial admin password can be easily printed with <code>docker compose exec</code>:</p> <pre><code>docker compose exec jenkins cat /var/jenkins_home/secrets/initialAdminPassword\n</code></pre> <p>In order to get started with Jenkins, the suggested plugins are often good a starting point. If you are planning to create pipeline projects with stages running in on-demand Docker containers, you will also need Docker Pipeline plugin. This can be installed through the Manage Jenkins &gt; Manage plugins menu.</p>"},{"location":"examples/jenkins/parallel-robot-pipeline/","title":"Parallel Robot Framework pipeline","text":"<p>This directory provides an example of a Jenkins pipeline that executes Robot Framework automation tasks with docker agent in parallel stages as well as combines and stores the produced HTML/XML report files.</p>"},{"location":"examples/jenkins/parallel-robot-pipeline/#preparing-the-jenkins-instance","title":"Preparing the Jenkins instance","text":"<p>The pipeline provided by this example can be added to any Jenkins instance you have administrator access and can run pipeline stages with docker agent. For example, Jenkins configuration from Jenkins with access to hosts Docker engine example can be used.</p> <p>In order to be able to run the pipeline we will need Docker Pipeline and Robot Framework plugins. Install these plugins through Available tab in Manage Jenkins &gt; Manage Plugins and restart the Jenkins instance after these plugins have been installed. The restart can be done, for example, from the plugins page or by restarting the container with <code>docker compose down</code> and <code>docker compose up</code>.</p>"},{"location":"examples/jenkins/parallel-robot-pipeline/#configure-the-pipeline","title":"Configure the pipeline","text":"<p>First, create a new pipeline via New Item button in the rigth side menu of the Jenkins dashboard. The name of the pipeline could be for example <code>Screenshots</code> and it should be an pipeline.</p> <p>In the configure pipeline view, scroll to the bottom and under Pipeline sub-header select <code>Pipeline script from SCM</code>. SCM type should be <code>Git</code> and Repository URL the url of this repository: <code>https://github.com/kangasta/cicd-examples.git</code>. Ensure that branch specifier includes <code>main</code> branch of the repository and modify the Script Path to be <code>docs/examples/jenkins/parallel-robot-pipeline/Jenkinsfile</code>.</p> <p>After you have created the pipeline, try to execute it by clicking Build Now. All Robot Framework tasks should be in Skipped state as we did not specify URL variable, see <code>.robot</code> file for details. In addition, after the first execution Jenkins should have updated the project configuration to contain parameters defined in the pipeline and we can now pass target URL to our automation tasks in Build with Parameters menu.</p> <p>Finally, If the robot log cannot be loaded after task execution, see this stackoverflow post for solution. To summarize, run following command in Jenkins Script Console to modify Jenkins servers Content Security Policy (CSP):</p> <pre><code>System.setProperty(\"hudson.model.DirectoryBrowserSupport.CSP\",\"sandbox allow-scripts; default-src 'none'; img-src 'self' data: ; style-src 'self' 'unsafe-inline' data: ; script-src 'self' 'unsafe-inline' 'unsafe-eval' ;\")\n</code></pre>"},{"location":"examples/jenkins/parallel-robot-pipeline/#running-the-example-scripts-locally","title":"Running the example scripts locally","text":"<p>Build the Docker containers with <code>docker build</code>:</p> <pre><code>docker build . --tag rf-screenshot\n</code></pre> <p>Execute the Robot Framework suites with <code>docker run</code>:</p> <pre><code># Chromium\ndocker run --rm -v $(pwd)/out:/out -e BROWSER=chromium rf-screenshot -d /out -v URL:https://kangasta.github.io/cicd-examples/\n\n# Firefox\ndocker run --rm -v $(pwd)/out:/out -e BROWSER=firefox rf-screenshot -d /out -v URL:https://kangasta.github.io/cicd-examples/\n</code></pre>"},{"location":"examples/jenkins/sonarqube-jenkins/","title":"Jenkins and SonarQube","text":"<p>This example uses the same Jenkins configuration as the Jenkins with access to hosts Docker engine example. If you did any configuration in jenkins-host-docker directory, sync the project names with <code>-p</code>/<code>--project-name</code> option or <code>COMPOSE_PROJECT_NAME</code> environment variable to use the same volumes. For example:</p> <pre><code># Replace jenkins with jenkins-host-docker, if you used default project name in jenkins-host-docker directory.\n\n# With -p/--project-name argument:\ndocker compose -p jenkins up -d\n\n# With COMPOSE_PROJECT_NAME environment variable:\nexport COMPOSE_PROJECT_NAME=jenkins\ndocker compose up -d\n</code></pre>"},{"location":"examples/jenkins/sonarqube-jenkins/#gettings-started-with-sonarqube","title":"Gettings started with SonarQube","text":"<p>To get started with SonarQube, access the Web UI and login with <code>admin:admin</code> credentials. Create a access token in My account &gt; Security and store the token. Use this access token to authenticate to SonarQube from CI instead of the username and password combination.</p> <p>In order to test the SonarQube installation, run <code>sonar-scanner</code> in a code repository. This can be done, for example, by using the sonarsource/sonar-scanner-cli Docker image:</p> <pre><code># This command should be run in the repository root directory\ndocker run \\\n  --rm \\\n  --net host \\\n  -e SONAR_HOST_URL=\"http://localhost:9000\" \\\n  -v ${PWD}:/usr/src \\\n  sonarsource/sonar-scanner-cli \\\n  -D\"sonar.projectKey=$(basename ${PWD})\" \\\n  -D\"sonar.login=${your_sonar_access_token}\"\n</code></pre> <p>If this succeeds, you are ready to move this analysis into Jenkins.</p>"},{"location":"examples/jenkins/sonarqube-jenkins/#using-sonarqube-from-jenkins-pipeline","title":"Using SonarQube from Jenkins pipeline","text":"<p>First, install SonarQube Scanner plugin to your Jenkins instance through Manage Jenkins &gt; Manage plugins menu. Configure SonarQube instance to SonarQube servers section of the Manage Jenkins &gt; Configure System menu: Use <code>http://sonarqube:9000</code> as the server URL and create a secret text credential for the access token you stored earlier.</p> <p>After the SonarQube server is configured to Jenkins, sonar-scanner can be executed in a stage that uses the same sonarsource/sonar-scanner-cli Docker image that was used in the previous step as well. This can be done with a stage level Docker agent:</p> <pre><code>stage('Analyze') {\n  agent {\n    docker {\n      image 'sonarsource/sonar-scanner-cli'\n      // In order to be able to use http://sonarqube:9000 we need to be in the\n      // same network as Jenkins and SonarQube are in.\n      args '--net jenkins_default'\n      // To guarantee that the workspace contains the sources pulled in previous\n      // stage, we need to use the pipeline level workspace.\n      reuseNode true\n    }\n  }\n  steps {\n    // The parameter must match the name you gave for the SonarQube server when\n    // configuring it.\n    withSonarQubeEnv('Sonar') {\n      // Here, job name is used as the project key and current workspace as the\n      // sources location.\n      sh \"\"\"\n        sonar-scanner \\\n          -D'sonar.projectKey=${JOB_NAME}'\\\n          -D'sonar.sources=${WORKSPACE}'\n      \"\"\"\n    }\n  }\n}\n</code></pre> <p>See Jenkinsfile for a example of a complete pipeline. If you try to execute this example pipeline replace <code>${GIT_URL}</code> with the URL to your git repository of choice.</p> <p>After the pipeline with sonar-scanner run has been executed, the job view in Jenkins should include the SonarQube quality gate status of the linked Sonar Project. Note that in this demo setup these links will not work as the Jenkins uses the <code>http://sonarqube:9000</code> URL for the SonarQube server which is likely not accessible from your browser. To see the projects in SonarQube, replace <code>http://sonarqube:9000</code> with <code>http://localhost:9000</code> in the URL.</p> <p>Alternative for using <code>http://sonarqube:9000</code> or <code>http://localhost:9000</code> as the SonarQube URL would be to use your host machines local IP: <code>http://${HOST_IP}:9000</code>. On linux systems, you can find your local IP with <code>hostname -I</code> command. On Windows systems, you can find your local by looking for IP address from the output of <code>ipconfig</code> command. You only need to configure this to the Manage Jenkins &gt; Configure System menu. When using local host IP, you can omit the network argument from docker agent block and the links from the job view should work as is.</p> <p>Note that this setup should only be used for development. For anything production like, configure SonarQube to use database such as postgres, do not use root or admin credentials, and setup the Jenkins and SonarQube to a suitable private network. See also Jenkins and SonarQube documentation for production usage instructions.</p>"}]}